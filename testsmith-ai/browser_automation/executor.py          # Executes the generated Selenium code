from selenium import webdriver
from selenium.webdriver.chrome.options import Options
import time

def execute_selenium_code(code: str, test_name: str) -> dict:
    """
    Executes a string of Selenium code in a headless browser.
    Captures results, logs, and screenshots. [cite: 34]
    """
    print("üöÄ Executing generated code...")
    chrome_options = Options()
    chrome_options.add_argument("--headless")
    chrome_options.add_argument("--window-size=1920,1080")
    driver = webdriver.Chrome(options=chrome_options)

    result = {
        "status": "Failure",
        "error": "No result captured.",
        "screenshot": None
    }

    try:
        # The 'driver' variable is made available to the executed code
        exec_globals = {"driver": driver}
        exec(code, exec_globals)
        result["status"] = "Success"
        result["error"] = None
        print("‚úÖ Execution successful.")
    except Exception as e:
        print(f"‚ùå Execution failed: {e}")
        result["error"] = str(e)
        screenshot_path = f"outputs/screenshots/{test_name.replace(' ', '_')}_{int(time.time())}.png"
        driver.save_screenshot(screenshot_path)
        result["screenshot"] = screenshot_path
    finally:
        driver.quit()
    
    return result